# -*- coding: utf-8 -*-
"""Untitled39.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KpQQ3HhfGKGYGf8oDd6WvPc1eevP1J0k
"""

import streamlit as st
import pandas as pd
import random

# --- ì´ˆê¸° ì„¤ì • ë° ë°ì´í„° (ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ê¶Œì¥) ---
st.set_page_config(page_title="í™˜ìŠ¹ ë§ˆë‹ˆë˜ : X-Signal", layout="wide")

# ì°¸ê°€ì ëª…ë‹¨ (ì—¬ê¸° 30ëª…ì˜ ì´ë¦„ì„ ë„£ìœ¼ì„¸ìš”)
PARTICIPANTS = [f"ì°¸ê°€ì{i}" for i in range(1, 31)]
NICKNAMES = ["í•´ì€", "í˜„ê·œ", "ë‚˜ì—°", "í¬ë‘", "ì§€ì—°", "íƒœì´", "ê·œë¯¼", "ì›ë¹ˆ", "ì§€ìˆ˜", "ë¯¼ê¸°",
             "ë‚˜ì–¸", "í˜„ì¤€", "ì„œê²½", "ì£¼ì›", "ìœ ì •", "ì°½ì§„", "ë‹¤í˜œ", "ë™ì§„", "ì¢…ì€", "ê´‘íƒœ",
             "íœ˜í˜„", "í˜œì›", "ìƒì •", "ë¯¼í˜•", "ì§€ìœ ", "ì •í›ˆ", "ì˜í¬", "ì² ìˆ˜", "ë²Œê¿€", "ì˜¤ì†Œë¦¬"]

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” (ë°ì´í„° íœ˜ë°œ ë°©ì§€ìš© - ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” DBë‚˜ íŒŒì¼ ì €ì¥ í•„ìš”)
if 'db' not in st.session_state:
    # ë§ˆë‹ˆë˜ ë§¤ì¹­
    targets = PARTICIPANTS[:]
    while True:
        random.shuffle(targets)
        if all(PARTICIPANTS[i] != targets[i] for i in range(len(PARTICIPANTS))):
            break

    # ì°¸ê°€ì ì •ë³´ DB êµ¬ì¶•
    db = {}
    for i, name in enumerate(PARTICIPANTS):
        db[name] = {
            "nickname": NICKNAMES[i],
            "target": targets[i],
            "status": "ì•„ì§ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.",
            "messages": [] # 1:1 ë©”ì‹œì§€í•¨
        }
    st.session_state.db = db
    st.session_state.global_chat = [] # ë‹¨ì²´í†¡

# --- ë¡œê·¸ì¸ í™”ë©´ ---
if 'user' not in st.session_state:
    st.title("ğŸ’˜ í™˜ìŠ¹ ë§ˆë‹ˆë˜ : X-Signal")
    login_name = st.selectbox("ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”", ["ì„ íƒí•˜ì„¸ìš”"] + PARTICIPANTS)
    if st.button("ì…ì¥í•˜ê¸°"):
        if login_name != "ì„ íƒí•˜ì„¸ìš”":
            st.session_state.user = login_name
            st.rerun()
else:
    user = st.session_state.user
    my_data = st.session_state.db[user]

    # ì‚¬ì´ë“œë°”: ë‚´ ì •ë³´
    st.sidebar.title(f"ğŸ‘¤ {my_data['nickname']}")
    st.sidebar.info(f"ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜(ì±™ê¸¸ ì‚¬ëŒ): **{my_data['target']}**")
    st.sidebar.write(f"ë‚˜ì˜ ìƒíƒœ: {my_data['status']}")

    if st.sidebar.button("ë¡œê·¸ì•„ì›ƒ"):
        del st.session_state.user
        st.rerun()

    # ë©”ì¸ í™”ë©´ íƒ­
    tab1, tab2, tab3 = st.tabs(["ğŸ’¬ ë‹¨ì²´ ìµëª…í†¡", "ğŸ’Œ X-ë©”ì‹œì§€ (1:1)", "ğŸ¯ ì˜¤ëŠ˜ì˜ ì„ íƒ"])

    # íƒ­ 1: ë‹¨ì²´ ìµëª…í†¡
    with tab1:
        st.subheader("ë‹¨ì²´ ìµëª… ê²Œì‹œíŒ")
        chat_input = st.text_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”", key="global")
        if st.button("ì „ì†¡", key="send_global"):
            st.session_state.global_chat.append(f"[{my_data['nickname']}] {chat_input}")
            st.rerun()

        for msg in reversed(st.session_state.global_chat):
            st.write(msg)

    # íƒ­ 2: 1:1 ë©”ì‹œì§€í•¨ (ë§ˆë‹ˆë˜ì—ê²Œ ë³´ë‚´ê¸°)
    with tab2:
        st.subheader(f"ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜({my_data['target']})ì—ê²Œ ë³´ë‚´ëŠ” ìª½ì§€")
        secret_msg = st.text_area("ìµëª…ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.")
        if st.button("ìª½ì§€ ë³´ë‚´ê¸°"):
            target_user = my_data['target']
            st.session_state.db[target_user]['messages'].append(f"Xë¡œë¶€í„°: {secret_msg}")
            st.success("ì „ì†¡ ì™„ë£Œ!")

        st.divider()
        st.subheader("ë‚˜ì—ê²Œ ì˜¨ ìª½ì§€")
        for m in reversed(my_data['messages']):
            st.write(f"ğŸ“© {m}")

    # íƒ­ 3: ì •ë‹µ ë§íˆê¸°
    with tab3:
        st.subheader("ë‚˜ì˜ ë§ˆë‹ˆë˜ëŠ” ëˆ„êµ¬ì¼ê¹Œ?")
        guess = st.selectbox("ì˜ì‹¬ë˜ëŠ” ì‚¬ëŒì„ ì„ íƒí•˜ì„¸ìš”", ["ì„ íƒí•˜ì„¸ìš”"] + PARTICIPANTS)
        if st.button("í™•ì¸"):
            actual_manitto = ""
            # ë‚˜ë¥¼ ë§ˆë‹ˆë˜ë¡œ ê°€ì§„ ì‚¬ëŒ ì°¾ê¸°
            for k, v in st.session_state.db.items():
                if v['target'] == user:
                    actual_manitto = k

            if guess == actual_manitto:
                st.balloons()
                st.success("ì •ë‹µì…ë‹ˆë‹¤! ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ë§ìŠµë‹ˆë‹¤. ğŸ¯")
                st.session_state.db[actual_manitto]['status'] = "ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ë‹¹ì‹ ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤! â¤ï¸"
            else:
                st.error("ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ì•„ë‹™ë‹ˆë‹¤. ğŸ¤«")
                if actual_manitto:
                    st.session_state.db[actual_manitto]['status'] = "ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ë‹¹ì‹ ì„ ì„ íƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ğŸ’”"

# --- ê´€ë¦¬ì ì „ìš© ë¹„ë°€ ì½”ë“œ ---
ADMIN_PASSWORD = "director123"  # ìš´ì˜ìë§Œ ì•„ëŠ” ë¹„ë°€ë²ˆí˜¸

if 'user' in st.session_state and st.session_state.user == "ìš´ì˜ì":
    st.title("ğŸ•¶ï¸ í™˜ìŠ¹ ë§ˆë‹ˆë˜ ê´€ì œ ì„¼í„°")

    # 1. ì „ì²´ ë§¤ì¹­ í˜„í™© í‘œë¡œ ë³´ê¸°
    st.subheader("ğŸ“Š ì „ì²´ ë§¤ì¹­ í˜„í™©")
    match_data = []
    for sender, info in st.session_state.db.items():
        match_data.append({
            "ë³´ë‚´ëŠ” ì‚¬ëŒ(ë³¸ëª…)": sender,
            "ë‹‰ë„¤ì„": info['nickname'],
            "ë°›ëŠ” ì‚¬ëŒ(ë§ˆë‹ˆë˜)": info['target'],
            "í˜„ì¬ ìƒíƒœ": info['status']
        })
    st.table(pd.DataFrame(match_data))

    # 2. ì‹¤ì‹œê°„ ë©”ì‹œì§€ ê°ì‹œ (í•„ìš”ì‹œ)
    st.subheader("ğŸ•µï¸ ì‹¤ì‹œê°„ 1:1 ë©”ì‹œì§€ ëª¨ë‹ˆí„°ë§")
    for receiver, info in st.session_state.db.items():
        if info['messages']:
            st.write(f"**{receiver}**ì—ê²Œ ì˜¨ ë©”ì‹œì§€: {info['messages'][-1]}")

    # 3. ì „ì²´ ê³µì§€ì‚¬í•­ ë‚ ë¦¬ê¸°
    st.subheader("ğŸ“¢ ì „ì²´ ê³µì§€")
    notice = st.text_input("ì „ì²´ í†¡ë°©ì— ë„ìš¸ ê³µì§€")
    if st.button("ê³µì§€ ì „ì†¡"):
        st.session_state.global_chat.append(f"ğŸš¨ [ê³µì§€] {notice}")
        st.success("ê³µì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.")

# ë¡œê·¸ì¸ í™”ë©´ì—ì„œ ìš´ì˜ì ì ‘ì† ì¶”ê°€
# login_name ì„ íƒì§€ì— "ìš´ì˜ì"ë¥¼ ë„£ê±°ë‚˜, ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ì„ ë”°ë¡œ ë§Œë“­ë‹ˆë‹¤.