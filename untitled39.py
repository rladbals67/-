# -*- coding: utf-8 -*-
"""Untitled39.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KpQQ3HhfGKGYGf8oDd6WvPc1eevP1J0k
"""

import streamlit as st
import pandas as pd
import random

# --- ì´ˆê¸° ì„¤ì • ë° ë°ì´í„° (ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ê¶Œì¥) ---
st.set_page_config(page_title="í™˜ìŠ¹ ë§ˆë‹ˆë˜ : X-Signal", layout="wide")

# ì°¸ê°€ì ëª…ë‹¨ (ì—¬ê¸° 30ëª…ì˜ ì´ë¦„ì„ ë„£ìœ¼ì„¸ìš”)
PARTICIPANTS = ["ë‹¨ë¹„", "ì°½ìš°", "ì£¼í¬", "ì˜¨ìœ ", "ìœ ë¯¼", "ì£¼í˜•", "6", "7", "8", "9", "10"]

# --- ì´ˆê¸° ì„¤ì • ë° ë°ì´í„° êµ¬ì¶• (ìˆ˜ì • ë²„ì „) ---
if 'db' not in st.session_state:
    # 1. ë§ˆë‹ˆë˜ ë§¤ì¹­ (ìê¸° ìì‹  ì œì™¸)
    targets = PARTICIPANTS[:]
    while True:
        random.shuffle(targets)
        if all(PARTICIPANTS[i] != targets[i] for i in range(len(PARTICIPANTS))):
            break
    
    # 2. ì°¸ê°€ì ì •ë³´ DB êµ¬ì¶•
    db = {}
    for i, name in enumerate(PARTICIPANTS):
        target_name = targets[i]
        # ë‹‰ë„¤ì„ì„ [ë§ˆë‹ˆë˜ ì´ë¦„ + "ë˜"]ë¡œ ì„¤ì •
        # ì´ë¦„ì˜ ë§ˆì§€ë§‰ ê¸€ìì— ë”°ë¼ 'ë˜'ë¥¼ ë¶™ì„
        custom_nickname = f"{target_name}ë˜" 
        
        db[name] = {
            "nickname": custom_nickname, # ì´ì œ ëœë¤ ë‹‰ë„¤ì„ ëŒ€ì‹  'í•˜ë‚˜ë˜'ì²˜ëŸ¼ ì €ì¥ë¨
            "target": target_name,
            "status": "ì•„ì§ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.",
            "messages": [] 
        }
    st.session_state.db = db
    st.session_state.global_chat = []
    

# --- ë¡œê·¸ì¸ í™”ë©´ (ìˆ˜ì • ë²„ì „) ---
if 'user' not in st.session_state:
    st.title("ğŸ’˜ í™˜ìŠ¹ ë§ˆë‹ˆë˜ : X-Signal")
    
    # ì´ë¦„ ì„ íƒ
    login_name = st.selectbox("ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”", ["ì„ íƒí•˜ì„¸ìš”", "ìš´ì˜ì"] + PARTICIPANTS)
    
    # ìš´ì˜ìë¥¼ ì„ íƒí–ˆì„ ë•Œë§Œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ì´ ë‚˜íƒ€ë‚¨
    if login_name == "ìš´ì˜ì":
        password = st.text_input("ìš´ì˜ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
        if st.button("ìš´ì˜ì ë¡œê·¸ì¸"):
            if password == "1234": # ì›í•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¡œ ë°”ê¾¸ì„¸ìš”!
                st.session_state.user = "ìš´ì˜ì"
                st.rerun()
            else:
                st.error("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.")
    
    # ì¼ë°˜ ì°¸ê°€ì ë¡œê·¸ì¸
    elif login_name != "ì„ íƒí•˜ì„¸ìš”":
        if st.button("ì…ì¥í•˜ê¸°"):
            st.session_state.user = login_name
            st.rerun()

    # ì‚¬ì´ë“œë°”: ë‚´ ì •ë³´
    st.sidebar.title(f"ğŸ‘¤ {my_data['nickname']}")
    st.sidebar.info(f"ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜(ì±™ê¸¸ ì‚¬ëŒ): **{my_data['target']}**")
    st.sidebar.write(f"ë‚˜ì˜ ìƒíƒœ: {my_data['status']}")

    if st.sidebar.button("ë¡œê·¸ì•„ì›ƒ"):
        del st.session_state.user
        st.rerun()

    # ë©”ì¸ í™”ë©´ íƒ­
    tab1, tab2, tab3 = st.tabs(["ğŸ’¬ ë‹¨ì²´ ìµëª…í†¡", "ğŸ’Œ X-ë©”ì‹œì§€ (1:1)", "ğŸ¯ ì˜¤ëŠ˜ì˜ ì„ íƒ"])

    # íƒ­ 1: ë‹¨ì²´ ìµëª…í†¡
    with tab1:
        st.subheader("ë‹¨ì²´ ìµëª… ê²Œì‹œíŒ")
        chat_input = st.text_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”", key="global")
        if st.button("ì „ì†¡", key="send_global"):
            st.session_state.global_chat.append(f"[{my_data['nickname']}] {chat_input}")
            st.rerun()

        for msg in reversed(st.session_state.global_chat):
            st.write(msg)

    # íƒ­ 2: 1:1 ë©”ì‹œì§€í•¨ (ë§ˆë‹ˆë˜ì—ê²Œ ë³´ë‚´ê¸°)
    with tab2:
        st.subheader(f"ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜({my_data['target']})ì—ê²Œ ë³´ë‚´ëŠ” ìª½ì§€")
        secret_msg = st.text_area("ìµëª…ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.")
        if st.button("ìª½ì§€ ë³´ë‚´ê¸°"):
            target_user = my_data['target']
            st.session_state.db[target_user]['messages'].append(f"Xë¡œë¶€í„°: {secret_msg}")
            st.success("ì „ì†¡ ì™„ë£Œ!")

        st.divider()
        st.subheader("ë‚˜ì—ê²Œ ì˜¨ ìª½ì§€")
        for m in reversed(my_data['messages']):
            st.write(f"ğŸ“© {m}")

    # íƒ­ 3: ì •ë‹µ ë§íˆê¸°
    with tab3:
        st.subheader("ë‚˜ì˜ ë§ˆë‹ˆë˜ëŠ” ëˆ„êµ¬ì¼ê¹Œ?")
        guess = st.selectbox("ì˜ì‹¬ë˜ëŠ” ì‚¬ëŒì„ ì„ íƒí•˜ì„¸ìš”", ["ì„ íƒí•˜ì„¸ìš”"] + PARTICIPANTS)
        if st.button("í™•ì¸"):
            actual_manitto = ""
            # ë‚˜ë¥¼ ë§ˆë‹ˆë˜ë¡œ ê°€ì§„ ì‚¬ëŒ ì°¾ê¸°
            for k, v in st.session_state.db.items():
                if v['target'] == user:
                    actual_manitto = k

            if guess == actual_manitto:
                st.balloons()
                st.success("ì •ë‹µì…ë‹ˆë‹¤! ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ë§ìŠµë‹ˆë‹¤. ğŸ¯")
                st.session_state.db[actual_manitto]['status'] = "ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ë‹¹ì‹ ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤! â¤ï¸"
            else:
                st.error("ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ì•„ë‹™ë‹ˆë‹¤. ğŸ¤«")
                if actual_manitto:
                    st.session_state.db[actual_manitto]['status'] = "ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ë‹¹ì‹ ì„ ì„ íƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ğŸ’”"

# --- ê´€ë¦¬ì ì „ìš© ë¹„ë°€ ì½”ë“œ ---
ADMIN_PASSWORD = "director123"  # ìš´ì˜ìë§Œ ì•„ëŠ” ë¹„ë°€ë²ˆí˜¸

if 'user' in st.session_state and st.session_state.user == "ìš´ì˜ì":
    st.title("ğŸ•¶ï¸ í™˜ìŠ¹ ë§ˆë‹ˆë˜ ê´€ì œ ì„¼í„°")

    # 1. ì „ì²´ ë§¤ì¹­ í˜„í™© í‘œë¡œ ë³´ê¸°
    st.subheader("ğŸ“Š ì „ì²´ ë§¤ì¹­ í˜„í™©")
    match_data = []
    for sender, info in st.session_state.db.items():
        match_data.append({
            "ë³´ë‚´ëŠ” ì‚¬ëŒ(ë³¸ëª…)": sender,
            "ë‹‰ë„¤ì„": info['nickname'],
            "ë°›ëŠ” ì‚¬ëŒ(ë§ˆë‹ˆë˜)": info['target'],
            "í˜„ì¬ ìƒíƒœ": info['status']
        })
    st.table(pd.DataFrame(match_data))

    # 2. ì‹¤ì‹œê°„ ë©”ì‹œì§€ ê°ì‹œ (í•„ìš”ì‹œ)
    st.subheader("ğŸ•µï¸ ì‹¤ì‹œê°„ 1:1 ë©”ì‹œì§€ ëª¨ë‹ˆí„°ë§")
    for receiver, info in st.session_state.db.items():
        if info['messages']:
            st.write(f"**{receiver}**ì—ê²Œ ì˜¨ ë©”ì‹œì§€: {info['messages'][-1]}")

    # 3. ì „ì²´ ê³µì§€ì‚¬í•­ ë‚ ë¦¬ê¸°
    st.subheader("ğŸ“¢ ì „ì²´ ê³µì§€")
    notice = st.text_input("ì „ì²´ í†¡ë°©ì— ë„ìš¸ ê³µì§€")
    if st.button("ê³µì§€ ì „ì†¡"):
        st.session_state.global_chat.append(f"ğŸš¨ [ê³µì§€] {notice}")
        st.success("ê³µì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.")

# ë¡œê·¸ì¸ í™”ë©´ì—ì„œ ìš´ì˜ì ì ‘ì† ì¶”ê°€
# login_name ì„ íƒì§€ì— "ìš´ì˜ì"ë¥¼ ë„£ê±°ë‚˜, ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ì„ ë”°ë¡œ ë§Œë“­ë‹ˆë‹¤.
